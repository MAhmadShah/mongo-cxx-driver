<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<meta name="keyword" content="">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <link rel="shortcut icon" href="https://mongocxx.org/img/favicon.png">

    <title>Thread and fork safety</title>

    <link rel="stylesheet" href="https://mongocxx.org/lib/bootstrap.css" type="text/css" />
<link rel="stylesheet" href="https://mongocxx.org/lib/font-awesome/css/font-awesome.min.css" type="text/css" />
<link rel="stylesheet" href="https://mongocxx.org/css/mongodb-docs.css" type="text/css" />
<link rel="stylesheet" href="https://mongocxx.org/css/overrides.css" type="text/css" />
<link rel="stylesheet" href="https://mongocxx.org/lib/highlight/styles/idea.css" />

  </head>

  <body>
  
  <section id="container" class="">
      
      <header id="header-db" class="row" role="navigation">
  <div class="header-content">
    <div class="toggle-nav pull-left">
        <i class="fa fa-bars"></i>
        <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
    </div>
    
    <div class="logo pull-left">
      <a href="https://mongocxx.org">
        <img src="https://mongocxx.org/img/logo-mongodb-header.png",
             alt="MongoDB C++ driver" />
      </a>
    </div>
    
    <div>
<div class="nav-items pull-right">
  <div id="search">
<form method="get" action="//www.google.com/search" target="_blank">
    <input type="text" name="searchQuery" size="20" value="" autocomplete="off" placeholder="Search">
    <input type="hidden" name="site" value="https://mongocxx.org">
    <input type="hidden" name="q" value="">
    <label for="searchQuery"><i class="fa fa-search fa-1"></i></label>
</form>
</div>

</div>
</div>

  </div>
</header>

      

      
<aside id="sidebar" class="sidebar">
    <div class="ssidebar nav-collapse">
      <div class="ssidebarwrapper">
        <h3>
          <a class="index-link" href="https://mongocxx.org">MongoDB C&#43;&#43; Driver Manual</a>
        </h3>

        
        <ul class="sidebar-menu">
          
          
          
          
          
          
          
          
          
          
          
          

          
          
            
            









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
    
      
    
  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
  
  
  
  
  
  
  

  
    
    
    
  
  


        
      
    
      
      
        
      
    
      
      
    
      
      
    
      
      
    
    
  


          
            
            









  
    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    
  


          
            
            









  


          
            
            









  


          
            
            









  


          
            
            









  


          
            
            









  
    
    
      
      
    
      
      
    
      
      
    
    
  


          

          

          
            
            













  




<li class="toctree-l1  current">
  <a href="/mongocxx-v3/" class="">
      <i class='fa fa-arrow-right'></i>
      <span>mongocxx (v3)</span>
      <span class="menu-arrow fa fa-angle-down"></span>
  </a>
    <ul  class="current">
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/polyfill-selection/">
        
        Choosing a C&#43;&#43;17 Polyfill
    </a>
  </li>


        
        
        
        
        
















<li class="toctree-l2 ">
  <a href="/mongocxx-v3/installation/" class="">
      
      <span>Installing the mongocxx driver</span>
      
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongocxx-v3/installation/windows/">
        
        Windows
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongocxx-v3/installation/macos/">
        
        macOS
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongocxx-v3/installation/linux/">
        
        Linux
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l3">
    <a href="/mongocxx-v3/installation/advanced/">
        
        Advanced Configuration and Installation Options
    </a>
  </li>


        
        
    </ul>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/configuration/">
        
        Configuring the mongocxx driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/client-side-encryption/">
        
        Client-Side Field Level Encryption with mongocxx
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/tutorial/">
        
        Tutorial for mongocxx
    </a>
  </li>


        
        
        
        
        













  




    <li class="toctree-l2">
    <a href="/mongocxx-v3/thread-safety/">
        
        Thread and fork safety
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/connection-pools/">
        
        Connection pools
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/working-with-bson/">
        
        Working with BSON
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/api-abi-versioning/">
        
        API and ABI versioning
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/mongocxx-v3/">
        
        The mongocxx (v3) driver
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            
















<li class="toctree-l1 ">
  <a href="/legacy-v1/" class="">
      <i class='fa fa-arrow-right'></i>
      <span>legacy (v1)</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/legacy-v1/installation/">
        
        Installing the legacy driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/legacy-v1/configuration/">
        
        Configuring the legacy driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/legacy-v1/tutorial/">
        
        Legacy driver tutorial
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/legacy-v1/working-with-bson/">
        
        Working with BSON
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/legacy-v1/breaking-changes/">
        
        Breaking changes from 26compat
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/legacy-v1/">
        
        The Legacy C&#43;&#43; Driver
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="https://mongocxx.org/api/current">
        <i class='fa fa-file-text-o'></i>
        API Documentation
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/getting-help/">
        <i class='fa fa-question'></i>
        Getting help
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/reporting-bugs/">
        <i class='fa fa-bug'></i>
        Reporting Bugs
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="https://github.com/mongodb/mongo-cxx-driver/">
        <i class='fa fa-github'></i>
        Source Code
    </a>
  </li>


          
            
            
















<li class="toctree-l1 ">
  <a href="/contributing/" class="">
      <i class='fa fa-pencil'></i>
      <span>Contributing</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/contributing/testing-mongocxx/">
        
        Testing the mongocxx driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/contributing/testing-legacy/">
        
        Testing the legacy driver
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/contributing/">
        
        Contribution Guidelines
    </a>
  </li>


        
        
    </ul>
  </li>


          
        </ul>
        
    </div>
  </div>
  

</aside>



      
      <section id="main-content" class="content">
          <section class="main-column pull-left">
            <div class="document">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body">


   
<a class="edit-link" href="https://github.com/mongodb/mongo-cxx-driver/blob/master/docs/content/mongocxx-v3/thread-safety.md" target="_blank" title="Edit mongocxx-v3/thread-safety.md on GitHub"><i class="fa fa-pencil-square-o"></i></a>










<div class="bc">
<ul>
  
  
  
  
  
  <li><a href="/mongocxx-v3/">mongocxx (v3)</a> <i class="fa fa-angle-right"></i></li>
  <li>Thread and fork safety</li>
</ul>
</div>


<h1>Thread and fork safety</h1>
<p>TLDR: <strong>Always give each thread its own <code>mongocxx::client</code></strong>.</p>
<p>In general each <code>mongocxx::client</code> object AND all of its child objects,
including <code>mongocxx::client_session</code>, <code>mongocxx::database</code>, <code>mongocxx::collection</code>,
and <code>mongocxx::cursor</code>, <strong>should be used by a single thread at a time</strong>. This
is true even for clients acquired from a <code>mongocxx::pool</code>.</p>
<p>Even if you create multiple child objects from a single <code>client</code>, and
synchronize them individually, that is unsafe as they will concurrently
modify internal structures of the <code>client</code>. The same is true if you copy a
child object.</p>
<h2 id="never-do-this">Never do this</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>instance instance{};
</span></span><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>uri uri{};
</span></span><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>client c{uri};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> db1 <span style="color:#f92672">=</span> c[<span style="color:#e6db74">&#34;db1&#34;</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> db2 <span style="color:#f92672">=</span> c[<span style="color:#e6db74">&#34;db2&#34;</span>];
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>mutex db1_mtx{};
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>mutex db2_mtx{};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> threadfunc <span style="color:#f92672">=</span> [](mongocxx<span style="color:#f92672">::</span>database<span style="color:#f92672">&amp;</span> db, std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&amp;</span> mtx) {
</span></span><span style="display:flex;"><span>  mtx.lock();
</span></span><span style="display:flex;"><span>  db[<span style="color:#e6db74">&#34;col&#34;</span>].insert_one({});
</span></span><span style="display:flex;"><span>  mtx.unlock();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// BAD! These two databases are individually synchronized, but they are derived from the same
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// client, so they can only be accessed by one thread at a time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t1([<span style="color:#f92672">&amp;</span>]() { threadfunc(db1, db1_mtx); threadfunc(db2, db2_mtx); });
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t2([<span style="color:#f92672">&amp;</span>]() { threadfunc(db2, db2_mtx); threadfunc(db1, db1_mtx); });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>t1.join();
</span></span><span style="display:flex;"><span>t2.join();
</span></span></code></pre></div><p>In the above example, even though the two databases are individually
synchronized, they are derived from the same client. There is shared state
inside the library that is now being modified without synchronization. The
same problem occurs if <code>db2</code> is a copy of <code>db1</code>.</p>
<h2 id="a-better-version">A better version</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>instance instance{};
</span></span><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>uri uri{};
</span></span><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>client c1{uri};
</span></span><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>client c2{uri};
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>mutex c1_mtx{};
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>mutex c2_mtx{};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> threadfunc <span style="color:#f92672">=</span> [](std<span style="color:#f92672">::</span>string dbname, mongocxx<span style="color:#f92672">::</span>client<span style="color:#f92672">&amp;</span> client, std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&amp;</span> mtx) {
</span></span><span style="display:flex;"><span>  mtx.lock();
</span></span><span style="display:flex;"><span>  client[dbname][<span style="color:#e6db74">&#34;col&#34;</span>].insert_one({});
</span></span><span style="display:flex;"><span>  mtx.unlock();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// These two clients are individually synchronized, so it is safe to share them between
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// threads.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t1([<span style="color:#f92672">&amp;</span>]() { threadfunc(<span style="color:#e6db74">&#34;db1&#34;</span>, c1, c1_mtx); threadfunc(<span style="color:#e6db74">&#34;db2&#34;</span>, c2, c2_mtx); });
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t2([<span style="color:#f92672">&amp;</span>]() { threadfunc(<span style="color:#e6db74">&#34;db2&#34;</span>, c2, c2_mtx); threadfunc(<span style="color:#e6db74">&#34;db1&#34;</span>, c1, c1_mtx); });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>t1.join();
</span></span><span style="display:flex;"><span>t2.join();
</span></span></code></pre></div><h2 id="the-best-version">The best version</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>instance instance{};
</span></span><span style="display:flex;"><span>mongocxx<span style="color:#f92672">::</span>pool pool{mongocxx<span style="color:#f92672">::</span>uri{}};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> threadfunc <span style="color:#f92672">=</span> [](mongocxx<span style="color:#f92672">::</span>client<span style="color:#f92672">&amp;</span> client, std<span style="color:#f92672">::</span>string dbname) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> col <span style="color:#f92672">=</span> client[dbname][<span style="color:#e6db74">&#34;col&#34;</span>].insert_one({});
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Great! Using the pool allows the clients to be synchronized while sharing only one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// background monitoring thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t1 ([<span style="color:#f92672">&amp;</span>]() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> c <span style="color:#f92672">=</span> pool.acquire();
</span></span><span style="display:flex;"><span>  threadfunc(<span style="color:#f92672">*</span>c, <span style="color:#e6db74">&#34;db1&#34;</span>);
</span></span><span style="display:flex;"><span>  threadfunc(<span style="color:#f92672">*</span>c, <span style="color:#e6db74">&#34;db2&#34;</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t2 ([<span style="color:#f92672">&amp;</span>]() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> c <span style="color:#f92672">=</span> pool.acquire();
</span></span><span style="display:flex;"><span>  threadfunc(<span style="color:#f92672">*</span>c, <span style="color:#e6db74">&#34;db2&#34;</span>);
</span></span><span style="display:flex;"><span>  threadfunc(<span style="color:#f92672">*</span>c, <span style="color:#e6db74">&#34;db1&#34;</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>t1.join();
</span></span><span style="display:flex;"><span>t2.join();
</span></span></code></pre></div><p>In most programs, clients will be long lived - so it is less of a hassle (and
more performant) to make one per-thread. Obviously in this contrived example,
there&rsquo;s quite a bit of overhead because we&rsquo;re doing so little work with each
client - but in a real program this is the best solution.</p>
<h2 id="fork-safety">Fork safety</h2>
<p>Neither a <code>mongocxx::client</code> or a <code>mongocxx::pool</code> can be safely copied
when forking. Because of this, any client or pool must be created <em>after</em>
forking, not before.</p>






<div id="btnv">
  
  <div class="pull-left">
  <a class="navigation prev" href="/mongocxx-v3/tutorial/">
      <i class="fa fa-long-arrow-left"> </i> Tutorial for mongocxx
  </a>
  </div>
  
  
  <div class="pull-right">
  <a class="navigation next" href="/mongocxx-v3/connection-pools/">
    Connection pools <i class="fa fa-long-arrow-right"> </i>
  </a>
  
</div>
</div>


</div>
<div class="right-column">
<div class="wrapper">
  
  <div class="toc">
    <span class="toc-header">On this page</span>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#never-do-this">Never do this</a></li>
    <li><a href="#a-better-version">A better version</a></li>
    <li><a href="#the-best-version">The best version</a></li>
    <li><a href="#fork-safety">Fork safety</a></li>
  </ul>
</nav>
  </div>
  
</div>
</div>

</div>
</div>
</div>
</section>
</section>

</section>


<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
   URL_ROOT:    "https://mongocxx.org",
   VERSION:      null ,
   COLLAPSE_INDEX: false,
   FILE_SUFFIX: '.html',
   HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="https://mongocxx.org/js/jquery.js"></script>
<script type="text/javascript" src="https://mongocxx.org/lib/bootstrap.js"></script>
<script type="text/javascript" src="https://mongocxx.org/js/navbar.js"></script>
<script type="text/javascript" src="https://mongocxx.org/lib/highlight/highlight.pack.js"></script>
<script type="text/javascript" src="https://mongocxx.org/js/scripts.js"></script>


<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-JQHP"
                 height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
  {'gtm.start': new Date().getTime(),event:'gtm.js'}
);var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-JQHP');</script>


<script type="text/javascript">
var _elqQ = _elqQ || [];
_elqQ.push(['elqSetSiteId', '413370795']);
_elqQ.push(['elqTrackPageView']);
(function () {
function async_load()
{ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//img03.en25.com/i/elqCfg.min.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }
if (window.addEventListener) window.addEventListener('DOMContentLoaded', async_load, false);
else if (window.attachEvent) window.attachEvent('onload', async_load);
})();
</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-7301842-14"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-7301842-14');
</script>


<script type="text/javascript">
  !function(e,t,r,n,a){if(!e[a]){for(var i=e[a]=[],s=0;s<r.length;s++){var c=r[s];i[c]=i[c]||function(e){return function(){var t=Array.prototype.slice.call(arguments);i.push([e,t])}}(c)}i.SNIPPET_VERSION="1.0.1";var o=t.createElement("script");o.type="text/javascript",o.async=!0,o.src="https://d2yyd1h5u9mauk.cloudfront.net/integrations/web/v1/library/"+n+"/"+a+".js";var l=t.getElementsByTagName("script")[0];l.parentNode.insertBefore(o,l)}}(window,document,["survey","reset","config","init","set","get","event","identify","track","page","screen","group","alias"],"Dk30CC86ba0nATlK","delighted");

  delighted.survey();
</script>
</body>
</html>

